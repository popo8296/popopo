<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>売上集計ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ADE0EE 0%, #73C2FB 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2em;
        }
        
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #73C2FB;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #73C2FB;
            background: #ADE0EE;
        }
        
        .file-row {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        
        .file-row .file-label-small {
            display: inline-block;
            padding: 7px 16px;
            background: #73C2FB;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .file-row .file-label-small:hover {
            background: #5AB3F5;
        }
        
        .file-row .file-name-inline {
            flex: 1;
            color: #555;
            font-size: 0.9em;
            text-align: left;
        }
        
        .file-row .remove-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.3em;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .file-row .remove-btn:hover {
            color: #e74c3c;
        }
        
        .product-group-item.preset {
            opacity: 0.55;
            background: #f0f0f0;
        }
        
        .product-group-item.preset .group-btn {
            pointer-events: none;
            cursor: default;
        }
        
        .product-group-item.preset .ratio-toggle {
            pointer-events: none;
            cursor: default;
        }
        
        .preset-badge {
            font-size: 0.75em;
            background: #aaa;
            color: white;
            border-radius: 4px;
            padding: 2px 7px;
            margin-left: 8px;
            font-weight: 600;
            vertical-align: middle;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
        
        input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        label.file-label {
            display: inline-block;
            padding: 12px 30px;
            background: #73C2FB;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        label.file-label:hover {
            background: #5AB3F5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(115, 194, 251, 0.4);
        }
        
        .file-name {
            display: block;
            margin-top: 10px;
            color: #555;
            font-size: 0.9em;
        }
        
        .group-assignment {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }
        
        .group-assignment h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .product-group-item {
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .product-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .ratio-controls {
            display: none;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .ratio-controls.active {
            display: flex;
        }
        
        .ratio-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
            cursor: pointer;
            padding: 5px 0;
        }
        
        .ratio-toggle input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .ratio-slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ratio-slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            background: linear-gradient(to right, #667eea 0%, #667eea 50%, #764ba2 50%, #764ba2 100%);
        }
        
        .ratio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid #73C2FB;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .ratio-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid #73C2FB;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .ratio-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .ratio-display {
            font-weight: 600;
            color: #333;
            min-width: 120px;
            text-align: center;
            background: white;
            padding: 8px 15px;
            border-radius: 6px;
            border: 2px solid #73C2FB;
        }
        
        .product-name {
            flex: 1;
            font-weight: 500;
            color: #333;
            margin-right: 20px;
        }
        
        .group-selector {
            display: flex;
            gap: 10px;
        }
        
        .group-btn {
            padding: 8px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .group-btn:hover {
            border-color: #73C2FB;
        }
        
        .group-btn.active {
            background: #73C2FB;
            color: white;
            border-color: #73C2FB;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .button-row {
            display: flex;
            gap: 20px;
        }
        
        button {
            padding: 14px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #73C2FB;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5AB3F5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(115, 194, 251, 0.4);
        }
        
        .btn-secondary {
            background: #ADE0EE;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #9AD6E6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(173, 224, 238, 0.4);
        }
        
        .btn-copy {
            background: #73C2FB;
            color: white;
        }
        
        .btn-copy:hover {
            background: #5AB3F5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(115, 194, 251, 0.4);
        }
        
        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #73C2FB 0%, #ADE0EE 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
            max-height: calc(80vh - 100px);
            overflow-y: auto;
        }
        
        .detail-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .detail-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .detail-summary-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1em;
            color: #73C2FB;
        }
        
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .detail-table th {
            background: #73C2FB;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .detail-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-table tr:hover {
            background: #f8f9fa;
        }
        
        .clickable-product {
            cursor: pointer;
            color: #73C2FB;
            transition: all 0.3s;
        }
        
        .clickable-product:hover {
            color: #5AB3F5;
            text-decoration: underline;
        }
        
        .results {
            display: none;
        }
        
        .results h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .chart-section {
            margin-top: 40px;
        }
        
        .chart-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .chart-tab {
            padding: 8px 20px;
            border: 2px solid #73C2FB;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            color: #73C2FB;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .chart-tab.active {
            background: #73C2FB;
            color: white;
        }
        
        .chart-tab:hover:not(.active) {
            background: #ADE0EE;
        }
        
        .chart-panel {
            display: none;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
        }
        
        .chart-panel.active {
            display: block;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 20px;
        }
        
        .chart-group-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .chart-group-toggle label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .forecast-note {
            background: white;
            border-left: 4px solid #73C2FB;
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            font-size: 0.85em;
            color: #555;
            margin-top: 15px;
        }
        
        .monthly-comparison {
            margin-top: 30px;
        }
        
        .month-summary-item {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #73C2FB;
        }
        
        .month-summary-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .month-summary-item.current-month {
            border-left-color: #F5A623;
            border-left-width: 5px;
        }
        
        .month-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .month-summary-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #333;
        }
        
        .month-summary-amount {
            font-size: 1.3em;
            font-weight: 700;
            color: #73C2FB;
        }
        
        .month-badge {
            background: #F5A623;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .month-comparison-badge {
            font-size: 0.9em;
            color: #666;
            margin-left: 15px;
        }
        
        .month-comparison-badge.positive {
            color: #28a745;
        }
        
        .month-comparison-badge.negative {
            color: #dc3545;
        }
        
        .month-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }
        
        .month-details.expanded {
            display: block;
        }
        
        .month-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .month-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .month-detail-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .month-detail-value {
            font-weight: 600;
            color: #333;
        }
        
        .expand-btn {
            background: #ADE0EE;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            transition: all 0.3s;
        }
        
        .expand-btn:hover {
            background: #73C2FB;
            color: white;
        }
        
        .daily-sales-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-top: 20px;
        }
        
        .daily-sales-column {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .daily-sales-column h4 {
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #73C2FB;
            color: #333;
            font-size: 1.1em;
        }
        
        .daily-sales-column.popo h4 {
            border-bottom-color: #73C2FB;
        }
        
        .daily-sales-column.po h4 {
            border-bottom-color: #ADE0EE;
        }
        
        .daily-sales-column.total h4 {
            border-bottom-color: #5AB3F5;
        }
        
        .daily-sales-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
        }
        
        .daily-sales-item:last-child {
            border-bottom: none;
        }
        
        .daily-sales-date {
            color: #666;
        }
        
        .daily-sales-amount {
            font-weight: 600;
            color: #333;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #73C2FB 0%, #ADE0EE 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .result-card h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .result-amount {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .result-detail {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: #73C2FB;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .amount-cell {
            font-weight: 600;
            color: #28a745;
            text-align: right;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            display: none;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="copy-notification" id="copyNotification">
        クリップボードにコピーしました
    </div>
    
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalProductName"></h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>
    
    <div class="container">
        <h1>売上集計ツール</h1>
        
        <div class="upload-section">
            <div id="fileInputList" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;"></div>
            <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
                <button class="btn-primary" onclick="addFileInput()" style="padding: 10px 25px; font-size: 0.95em;">CSVファイルを追加</button>
                <button class="btn-secondary" onclick="document.getElementById('unifiedFileInput').click()" style="padding: 10px 25px; font-size: 0.95em;">統合CSVを読み込む</button>
                <input type="file" id="unifiedFileInput" accept=".csv" style="display:none;" onchange="loadUnifiedData(this)">
            </div>
            <div id="settingsLoadedMsg" style="display:none; margin-top:10px; color:#73C2FB; font-weight:600; font-size:0.9em;">データを読み込みました</div>
        </div>
        
        <div class="group-assignment" id="groupAssignment">
            <h2>商品のグループ分け</h2>
            <div id="productList"></div>
        </div>
        
        <div class="action-buttons" id="actionButtons" style="display: none;">
            <div style="margin-bottom: 10px; text-align: center;">
                <label style="font-size: 1.1em; font-weight: 600; color: #333; margin-right: 10px;">
                    振込手数料:
                </label>
                <input type="number" id="transferFee" value="200" 
                       style="padding: 10px 20px; border: 2px solid #73C2FB; border-radius: 6px; font-size: 1em; width: 150px; text-align: right;">
                <span style="margin-left: 5px; color: #666;">円</span>
            </div>
            <div class="button-row">
                <button class="btn-primary" onclick="calculateResults()">集計実行</button>
                <button class="btn-secondary" onclick="saveUnifiedData()">統合CSVを保存</button>
                <button class="btn-copy" onclick="copyResultsAsText()">テキストコピー</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>集計中...</p>
        </div>
        
        <div class="results" id="results">
            <h2>集計結果</h2>
            
            <div class="results-grid" id="summaryCards"></div>
            
            <!-- 日別売上 -->
            <div id="dailySalesSection" style="display:none; margin-top:30px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="color:#333; margin:0;">日別売上</h3>
                    <button class="expand-btn" onclick="toggleDailySales()" id="dailySalesToggleBtn">表示</button>
                </div>
                <div id="dailySalesContent" style="display:none;"></div>
            </div>
            
            <!-- 月別比較（コンパクト版） -->
            <div class="monthly-comparison" id="monthlyComparison" style="display:none; margin-top:30px;">
                <h3 style="color:#333; margin-bottom:15px;">月別データ</h3>
                <div id="monthlyComparisonContent"></div>
            </div>
            
            <!-- 通算合算 -->
            <div id="totalSummarySection" style="display:none; margin-top:30px;">
                <h3 style="color:#333; margin-bottom:15px;">通算合算</h3>
                <div class="results-grid" id="totalSummaryCards"></div>
            </div>
            
            <table id="detailsTable"></table>
        </div>
        
        <div class="chart-section" id="chartSection" style="display:none;">
            <h2>グラフ・分析</h2>
            <div class="chart-tabs">
                <button class="chart-tab active" onclick="switchTab('daily')">日別売上</button>
                <button class="chart-tab" onclick="switchTab('monthly')">月別売上</button>
                <button class="chart-tab" onclick="switchTab('forecast')">売上予測</button>
            </div>
            
            <!-- 日別 -->
            <div class="chart-panel active" id="panel-daily">
                <div class="chart-group-toggle">
                    <span style="font-weight:600; margin-right:5px;">表示:</span>
                    <label><input type="checkbox" id="daily-popo" checked onchange="renderDailyChart()"> ぽぽ</label>
                    <label><input type="checkbox" id="daily-po" checked onchange="renderDailyChart()"> ぽ</label>
                    <label><input type="checkbox" id="daily-total" checked onchange="renderDailyChart()"> 合計</label>
                </div>
                <div class="chart-container"><canvas id="dailyChart"></canvas></div>
            </div>
            
            <!-- 月別 -->
            <div class="chart-panel" id="panel-monthly">
                <div class="chart-group-toggle">
                    <span style="font-weight:600; margin-right:5px;">表示:</span>
                    <label><input type="checkbox" id="monthly-popo" checked onchange="renderMonthlyChart()"> ぽぽ</label>
                    <label><input type="checkbox" id="monthly-po" checked onchange="renderMonthlyChart()"> ぽ</label>
                    <label><input type="checkbox" id="monthly-total" checked onchange="renderMonthlyChart()"> 合計</label>
                </div>
                <div class="chart-container"><canvas id="monthlyChart"></canvas></div>
            </div>
            
            <!-- 予測 -->
            <div class="chart-panel" id="panel-forecast">
                <div class="chart-group-toggle">
                    <span style="font-weight:600; margin-right:5px;">予測対象:</span>
                    <label><input type="radio" name="forecast-group" value="total" checked onchange="renderForecastChart()"> 合計</label>
                    <label><input type="radio" name="forecast-group" value="popo" onchange="renderForecastChart()"> ぽぽ</label>
                    <label><input type="radio" name="forecast-group" value="po" onchange="renderForecastChart()"> ぽ</label>
                    &nbsp;&nbsp;
                    <span style="font-weight:600; margin-right:5px;">予測期間:</span>
                    <select id="forecastMonths" onchange="renderForecastChart()" style="padding:5px 10px; border:2px solid #73C2FB; border-radius:6px; font-size:0.9em;">
                        <option value="1">1ヶ月</option>
                        <option value="3" selected>3ヶ月</option>
                        <option value="6">6ヶ月</option>
                        <option value="12">12ヶ月</option>
                    </select>
                </div>
                <div class="chart-container"><canvas id="forecastChart"></canvas></div>
                <div class="forecast-note" id="forecastNote"></div>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let productGroups = {};
        let productRatios = {};
        let results = [];
        let rawDataMap = {};
        let fileCounter = 0;
        let fileNames = [];
        let originalFileName = '';
        let presetProducts = {};
        let productIdToName = {};

        // ====== グループ設定の保存・読み込み ======
        function saveUnifiedData() {
            // CSVデータに設定情報を追加列として保存
            let csv = '\uFEFF'; // BOM
            
            // ヘッダー行：元のBOOTHのヘッダー + 設定列
            const headers = ['注文日時', '商品ID', '商品名', '購入者', '小計', 'サービス利用料・倉庫発送手数料', '受取金額', '設定_グループ', '設定_分配割合', '設定_分配有効'];
            csv += headers.join(',') + '\n';
            
            // データ行
            csvData.forEach(row => {
                const productName = row['商品名'];
                const group = productGroups[productName] || 1;
                const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                const ratioEl = document.getElementById(`ratio_${safeId}`);
                const isRatioEnabled = ratioEl && ratioEl.classList.contains('active');
                const ratio = productRatios[productName] || 50;
                
                // 元のデータ
                const orderDate = row['注文日時'] || '';
                const productId = row['商品ID'] || '';
                const productNameVal = `"${(row['商品名'] || '').replace(/"/g, '""')}"`;
                const buyer = `"${(row['購入者'] || '').replace(/"/g, '""')}"`;
                const subtotal = row['小計'] || '0';
                const fee = row['サービス利用料・倉庫発送手数料'] || '0';
                const amount = row['受取金額'] || '0';
                
                // 設定データ
                const settingGroup = group === 1 ? 'ぽぽ' : 'ぽ';
                const settingRatio = ratio;
                const settingEnabled = isRatioEnabled ? '有効' : '無効';
                
                csv += `${orderDate},${productId},${productNameVal},${buyer},${subtotal},${fee},${amount},${settingGroup},${settingRatio},${settingEnabled}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            const dateStr = new Date().toISOString().split('T')[0];
            link.setAttribute('download', `booth_unified_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function loadUnifiedData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const text = e.target.result;
                    const rows = parseCSVToRows(text);
                    
                    // 設定列があるかチェック
                    const hasSettings = rows.length > 0 && rows[0]['設定_グループ'];
                    
                    if (hasSettings) {
                        // 統合CSVファイル
                        csvData = [];
                        presetProducts = {};
                        productGroups = {};
                        productRatios = {};
                        
                        rows.forEach(row => {
                            const productName = row['商品名'];
                            const settingGroup = row['設定_グループ'];
                            const settingRatio = parseInt(row['設定_分配割合']) || 50;
                            const settingEnabled = row['設定_分配有効'] === '有効';
                            
                            // 設定を復元（最初の行のみ）
                            if (productName && !presetProducts[productName]) {
                                const group = settingGroup === 'ぽぽ' ? 1 : 2;
                                presetProducts[productName] = {
                                    group,
                                    ratio: settingRatio,
                                    ratioEnabled: settingEnabled
                                };
                                productGroups[productName] = group;
                                productRatios[productName] = settingRatio;
                            }
                            
                            // CSVデータに追加（設定列は除外）
                            const cleanRow = {
                                '注文日時': row['注文日時'],
                                '商品ID': row['商品ID'],
                                '商品名': row['商品名'],
                                '購入者': row['購入者'],
                                '小計': row['小計'],
                                'サービス利用料・倉庫発送手数料': row['サービス利用料・倉庫発送手数料'],
                                '受取金額': row['受取金額']
                            };
                            csvData.push(cleanRow);
                        });
                        
                        document.getElementById('settingsLoadedMsg').textContent = `統合ファイルを読み込みました（${Object.keys(presetProducts).length}商品の設定を復元）`;
                        document.getElementById('settingsLoadedMsg').style.display = 'block';
                        setTimeout(() => document.getElementById('settingsLoadedMsg').style.display = 'none', 3000);
                        
                        // 商品リスト表示
                        const uniqueProducts = new Set(csvData.map(r => r['商品名']));
                        displayProductList(Array.from(uniqueProducts));
                        
                    } else {
                        // 通常のBOOTH CSVファイル
                        alert('これは通常のBOOTH CSVファイルです。「CSVファイルを追加」から読み込んでください。');
                    }
                } catch(err) {
                    alert('統合ファイルの読み込みに失敗しました: ' + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file, 'UTF-8');
            input.value = '';
        }

        function toggleOldMonths() {
            const old = document.getElementById('oldMonths');
            const btn = event.target;
            old.classList.toggle('expanded');
            btn.textContent = old.classList.contains('expanded') ? '過去の月を隠す' : '過去の月を表示';
        }

        function displayMonthlyComparison() {
            if (results.length === 0) {
                document.getElementById('monthlyComparison').style.display = 'none';
                return;
            }

            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;

            // CSVから全ての月を集計
            const allMonthData = {};
            csvData.forEach(row => {
                const productName = row['商品名'];
                const amount = parseFloat(row['受取金額']) || 0;
                const subtotal = parseFloat(row['小計']) || 0;
                
                const rawDate = (row['注文日時'] || '').split(' ')[0];
                if (!rawDate) return;
                const dateStr = rawDate.replace(/\//g, '-');
                const monthStr = dateStr.substring(0, 7);

                const selectedGroup = productGroups[productName] || 1;
                const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                const ratioEl = document.getElementById(`ratio_${safeId}`);
                const isRatioEnabled = ratioEl && ratioEl.classList.contains('active');

                let popoAmt = 0, poAmt = 0, popoSub = 0, poSub = 0;
                if (isRatioEnabled) {
                    const ratio = productRatios[productName] || 50;
                    popoAmt = amount * (ratio / 100);
                    poAmt = amount * ((100 - ratio) / 100);
                    popoSub = subtotal * (ratio / 100);
                    poSub = subtotal * ((100 - ratio) / 100);
                } else {
                    if (selectedGroup === 1) {
                        popoAmt = amount;
                        popoSub = subtotal;
                    } else {
                        poAmt = amount;
                        poSub = subtotal;
                    }
                }

                if (!allMonthData[monthStr]) allMonthData[monthStr] = { popo: 0, po: 0, popoSub: 0, poSub: 0, count: 0 };
                allMonthData[monthStr].popo += popoAmt;
                allMonthData[monthStr].po += poAmt;
                allMonthData[monthStr].popoSub += popoSub;
                allMonthData[monthStr].poSub += poSub;
                allMonthData[monthStr].count += 1;
            });

            const allMonths = Object.keys(allMonthData).sort();
            
            // 履歴データを統合
            const allMonthsMap = {};
            
            // CSVから読み込んだ月データ
            allMonths.forEach(m => {
                const d = allMonthData[m];
                const popo = Math.floor(d.popo);
                const po = Math.floor(d.po);
                const total = popo + po;
                const popoS = Math.floor(d.popoSub);
                const poS = Math.floor(d.poSub);
                const sub = popoS + poS;
                const boothFee = sub - total;
                const ratio1 = total > 0 ? popo / total : 0.5;
                const ratio2 = total > 0 ? po / total : 0.5;
                const fee1 = transferFee * ratio1;
                const fee2 = transferFee * ratio2;
                const net1 = popo - fee1;
                const net2 = po - fee2;
                const netTotal = net1 + net2;
                
                allMonthsMap[m] = {
                    month: m,
                    popo, po, total,
                    popoSub: popoS, poSub: poS, subtotal: sub,
                    boothFee, count: d.count,
                    ratio1, ratio2, fee1, fee2,
                    net1, net2, netTotal
                };
            });
            
            // 全ての月を時系列順に並べる
            const monthsInfo = Object.keys(allMonthsMap).sort().map(m => allMonthsMap[m]);
            
            if (monthsInfo.length === 0) {
                document.getElementById('monthlyComparison').style.display = 'none';
                return;
            }

            const latestMonth = monthsInfo[monthsInfo.length - 1];
            const prevMonth = monthsInfo.length > 1 ? monthsInfo[monthsInfo.length - 2] : null;

            let html = '';

            // 今月
            const latestBadge = `<span class="month-badge">今月</span>`;
            let comparisonText = '';
            if (prevMonth) {
                const diff = Math.floor(latestMonth.netTotal - prevMonth.netTotal);
                const diffPct = prevMonth.netTotal > 0 ? ((diff / prevMonth.netTotal) * 100).toFixed(1) : 0;
                const isPos = diff >= 0;
                comparisonText = `<span class="month-comparison-badge ${isPos ? 'positive' : 'negative'}">先月比 ${isPos ? '+' : ''}¥${diff.toLocaleString()} (${isPos ? '+' : ''}${diffPct}%) ${isPos ? '↑' : '↓'}</span>`;
            }
            
            html += `
                <div class="month-summary-item current-month" onclick="toggleMonthDetails('month_${latestMonth.month}')">
                    <div class="month-summary-header">
                        <div>
                            <span class="month-summary-title">${latestMonth.month}</span>
                            ${latestBadge}
                            ${comparisonText}
                        </div>
                        <div class="month-summary-amount">¥${Math.floor(latestMonth.netTotal).toLocaleString()}</div>
                    </div>
                    <div class="month-details" id="month_${latestMonth.month}">
                        <div class="month-details-grid">
                            <div class="month-detail-item"><span class="month-detail-label">ぽぽ受取</span><span class="month-detail-value">¥${Math.floor(latestMonth.net1).toLocaleString()}</span></div>
                            <div class="month-detail-item"><span class="month-detail-label">ぽ受取</span><span class="month-detail-value">¥${Math.floor(latestMonth.net2).toLocaleString()}</span></div>
                            <div class="month-detail-item"><span class="month-detail-label">売上（手数料前）</span><span class="month-detail-value">¥${latestMonth.subtotal.toLocaleString()}</span></div>
                            <div class="month-detail-item"><span class="month-detail-label">BOOTH手数料</span><span class="month-detail-value">-¥${Math.abs(latestMonth.boothFee).toLocaleString()}</span></div>
                            <div class="month-detail-item"><span class="month-detail-label">手数料差引後</span><span class="month-detail-value">¥${latestMonth.total.toLocaleString()}</span></div>
                            <div class="month-detail-item"><span class="month-detail-label">振込手数料</span><span class="month-detail-value">-¥${Math.floor(transferFee).toLocaleString()}</span></div>
                            <div class="month-detail-item"><span class="month-detail-label">売上割合</span><span class="month-detail-value">ぽぽ ${(latestMonth.ratio1 * 100).toFixed(1)}% / ぽ ${(latestMonth.ratio2 * 100).toFixed(1)}%</span></div>
                            <div class="month-detail-item"><span class="month-detail-label">販売件数</span><span class="month-detail-value">${latestMonth.count}件</span></div>
                        </div>
                    </div>
                </div>
            `;

            // 過去の月（新しい順）
            for (let i = monthsInfo.length - 2; i >= 0; i--) {
                const m = monthsInfo[i];
                html += `
                    <div class="month-summary-item" onclick="toggleMonthDetails('month_${m.month}')">
                        <div class="month-summary-header">
                            <div><span class="month-summary-title">${m.month}</span></div>
                            <div class="month-summary-amount">¥${Math.floor(m.netTotal).toLocaleString()}</div>
                        </div>
                        <div class="month-details" id="month_${m.month}">
                            <div class="month-details-grid">
                                <div class="month-detail-item"><span class="month-detail-label">ぽぽ受取</span><span class="month-detail-value">¥${Math.floor(m.net1).toLocaleString()}</span></div>
                                <div class="month-detail-item"><span class="month-detail-label">ぽ受取</span><span class="month-detail-value">¥${Math.floor(m.net2).toLocaleString()}</span></div>
                                <div class="month-detail-item"><span class="month-detail-label">売上（手数料前）</span><span class="month-detail-value">¥${m.subtotal.toLocaleString()}</span></div>
                                <div class="month-detail-item"><span class="month-detail-label">BOOTH手数料</span><span class="month-detail-value">-¥${Math.abs(m.boothFee).toLocaleString()}</span></div>
                                <div class="month-detail-item"><span class="month-detail-label">手数料差引後</span><span class="month-detail-value">¥${m.total.toLocaleString()}</span></div>
                                <div class="month-detail-item"><span class="month-detail-label">振込手数料</span><span class="month-detail-value">-¥${Math.floor(transferFee).toLocaleString()}</span></div>
                                <div class="month-detail-item"><span class="month-detail-label">売上割合</span><span class="month-detail-value">ぽぽ ${(m.ratio1 * 100).toFixed(1)}% / ぽ ${(m.ratio2 * 100).toFixed(1)}%</span></div>
                                <div class="month-detail-item"><span class="month-detail-label">販売件数</span><span class="month-detail-value">${m.count}件</span></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('monthlyComparisonContent').innerHTML = html;
            document.getElementById('monthlyComparison').style.display = 'block';
            
            // 通算合算を計算
            let totalPopo = 0, totalPo = 0, totalSub = 0;
            let totalCount = 0;
            monthsInfo.forEach(m => {
                totalPopo += m.net1;
                totalPo += m.net2;
                totalSub += m.subtotal;
                totalCount += m.count;
            });
            const totalNet = totalPopo + totalPo;
            const totalBoothFee = totalSub - (monthsInfo.reduce((s, m) => s + m.total, 0));
            const totalTransferFee = transferFee * monthsInfo.length;
            const totalGrandTotal = monthsInfo.reduce((s, m) => s + m.total, 0);
            const totalPopoRatio = totalGrandTotal > 0 ? (totalGrandTotal - totalPo) / totalGrandTotal : 0.5;
            const totalPoRatio = totalGrandTotal > 0 ? totalPo / totalGrandTotal : 0.5;
            
            const cardStyle = `style="margin-top: 15px; padding: 10px 20px; background: white; color: #73C2FB; border: 2px solid white; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.9)'" onmouseout="this.style.background='white'"`;
            const dividerStyle = `style="border-top: 1px solid rgba(255,255,255,0.3); margin: 12px 0;"`;
            const rowStyle = `style="display:flex; justify-content:space-between; padding: 3px 0; font-size:0.9em;"`;
            const labelStyle = `style="opacity:0.85;"`;
            const valueStyle = `style="font-weight:600;"`;
            
            const totalSummaryHTML = `
                <div class="result-card">
                    <h3>ぽぽ（通算）</h3>
                    <div class="result-amount">¥${Math.floor(totalPopo).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(monthsInfo.reduce((s, m) => s + m.popoSub, 0)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料</span><span ${valueStyle}>-¥${Math.floor(monthsInfo.reduce((s, m) => s + (m.popoSub - m.popo), 0)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(monthsInfo.reduce((s, m) => s + m.popo, 0)).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>販売件数</span><span ${valueStyle}>${totalCount}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>売上割合</span><span ${valueStyle}>${(totalPopoRatio * 100).toFixed(1)}%</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料累計</span><span ${valueStyle}>-¥${Math.floor(monthsInfo.reduce((s, m) => s + m.fee1, 0)).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(totalPopo).toLocaleString()}</span></div>
                </div>
                <div class="result-card">
                    <h3>ぽ（通算）</h3>
                    <div class="result-amount">¥${Math.floor(totalPo).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(monthsInfo.reduce((s, m) => s + m.poSub, 0)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料</span><span ${valueStyle}>-¥${Math.floor(monthsInfo.reduce((s, m) => s + (m.poSub - m.po), 0)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(monthsInfo.reduce((s, m) => s + m.po, 0)).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>販売件数</span><span ${valueStyle}>${totalCount}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>売上割合</span><span ${valueStyle}>${(totalPoRatio * 100).toFixed(1)}%</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料累計</span><span ${valueStyle}>-¥${Math.floor(monthsInfo.reduce((s, m) => s + m.fee2, 0)).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(totalPo).toLocaleString()}</span></div>
                </div>
                <div class="result-card">
                    <h3>総合計（通算）</h3>
                    <div class="result-amount">¥${Math.floor(totalNet).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(totalSub).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料累計</span><span ${valueStyle}>-¥${Math.floor(Math.abs(totalBoothFee)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(totalGrandTotal).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>総販売件数</span><span ${valueStyle}>${totalCount}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料累計</span><span ${valueStyle}>-¥${Math.floor(totalTransferFee).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(totalNet).toLocaleString()}</span></div>
                </div>
            `;
            
            document.getElementById('totalSummaryCards').innerHTML = totalSummaryHTML;
            document.getElementById('totalSummarySection').style.display = 'block';
        }

        function toggleMonthDetails(id) {
            const details = document.getElementById(id);
            if (details) {
                details.classList.toggle('expanded');
            }
        }

        // 初期化：スクリプト読み込み後に最初のファイル入力行を追加
        document.addEventListener('DOMContentLoaded', () => { addFileInput(); });

        function addFileInput() {
            fileCounter++;
            const id = fileCounter;
            const container = document.getElementById('fileInputList');

            const row = document.createElement('div');
            row.className = 'file-row';
            row.id = `fileRow_${id}`;

            row.innerHTML = `
                <input type="file" id="csvInput_${id}" accept=".csv" style="display:none;">
                <label for="csvInput_${id}" class="file-label-small">ファイル ${id} を選択</label>
                <span class="file-name-inline" id="fileNameLabel_${id}">選択されていません</span>
                <button class="remove-btn" onclick="removeFileInput(${id})" title="削除">&times;</button>
            `;

            container.appendChild(row);

            document.getElementById(`csvInput_${id}`).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                document.getElementById(`fileNameLabel_${id}`).textContent = file.name;
                readFileIntoMap(file, id);
            });
        }

        function removeFileInput(id) {
            const row = document.getElementById(`fileRow_${id}`);
            if (row) row.remove();
            delete rawDataMap[id];
            rebuildCsvData();
        }

        function readFileIntoMap(file, id) {
            const reader = new FileReader();
            reader.onload = function(e) {
                rawDataMap[id] = { name: file.name.replace('.csv', ''), rows: parseCSVToRows(e.target.result) };
                rebuildCsvData();
            };
            reader.readAsText(file, 'UTF-8');
        }

        function rebuildCsvData() {
            csvData = [];
            fileNames = [];
            Object.values(rawDataMap).forEach(f => {
                csvData = csvData.concat(f.rows);
                fileNames.push(f.name);
            });
            originalFileName = fileNames.join('_');

            // 商品IDで名前を統一（最初に登場した名前を代表名にする）
            csvData.forEach(row => {
                const pid = row['商品ID'];
                if (pid && !productIdToName[pid]) {
                    productIdToName[pid] = row['商品名'];
                }
            });

            // 全行の商品名を代表名に統一
            csvData.forEach(row => {
                const pid = row['商品ID'];
                if (pid && productIdToName[pid]) {
                    row['商品名'] = productIdToName[pid];
                }
            });

            const uniqueProducts = new Set();
            csvData.forEach(row => uniqueProducts.add(row['商品名']));

            // 新商品だけデフォルト設定（既存設定・preset設定は保持）
            uniqueProducts.forEach(product => {
                if (productGroups[product] === undefined) productGroups[product] = 1;
                if (productRatios[product] === undefined) productRatios[product] = 50;
            });

            displayProductList(Array.from(uniqueProducts));
        }

        function parseCSVToRows(text) {
            const lines = text.split('\n');
            const headers = parseCSVLine(lines[0]);
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.replace(/^\uFEFF/, '').trim()] = values[index];
                        });
                        if (!row['受取金額'] || row['受取金額'].trim() === '') {
                            row['受取金額'] = '0';
                        }
                        rows.push(row);
                    }
                }
            }
            return rows;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result.map(v => v.replace(/^"|"$/g, ''));
        }

        function displayProductList(products) {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';
            
            // 設定済みを先に、新規を後に並べる
            const sorted = [...products].sort((a, b) => {
                const aPreset = !!presetProducts[a];
                const bPreset = !!presetProducts[b];
                if (aPreset !== bPreset) return aPreset ? -1 : 1;
                return a.localeCompare(b, 'ja');
            });

            sorted.forEach(product => {
                const isPreset = !!presetProducts[product];
                const ratio = productRatios[product] ?? 50;
                const popoRatio = ratio;
                const poRatio = 100 - ratio;
                const safeId = product.replace(/[^a-zA-Z0-9]/g, '_');
                const presetData = presetProducts[product];
                const ratioEnabled = isPreset && presetData.ratioEnabled;

                const div = document.createElement('div');
                div.className = `product-group-item${isPreset ? ' preset' : ''}`;
                div.innerHTML = `
                    <div class="product-row">
                        <div class="product-name">
                            ${product}
                            ${isPreset ? '<span class="preset-badge">設定済み</span>' : ''}
                        </div>
                        <div class="group-selector">
                            <button class="group-btn ${productGroups[product] === 1 ? 'active' : ''}" 
                                    onclick="setGroup('${product.replace(/'/g, "\\'")}', 1)">ぽぽ</button>
                            <button class="group-btn ${productGroups[product] === 2 ? 'active' : ''}" 
                                    onclick="setGroup('${product.replace(/'/g, "\\'")}', 2)">ぽ</button>
                        </div>
                    </div>
                    <label class="ratio-toggle" ${isPreset ? 'style="pointer-events:none;"' : ''}>
                        <input type="checkbox" id="check_${safeId}" ${ratioEnabled ? 'checked' : ''} onchange="toggleRatioSlider('${safeId}')">
                        利益分配割合を設定する
                    </label>
                    <div class="ratio-controls ${ratioEnabled ? 'active' : ''}" id="ratio_${safeId}">
                        <div style="min-width: 80px; font-weight: 600; color: #73C2FB;">利益分配:</div>
                        <div class="ratio-slider-container">
                            <input type="range" min="0" max="100" step="5" value="${ratio}" 
                                   class="ratio-slider" id="slider_${safeId}"
                                   oninput="updateRatio('${product.replace(/'/g, "\\'")}', this.value)"
                                   style="background: linear-gradient(to right, #73C2FB 0%, #73C2FB ${ratio}%, #ADE0EE ${ratio}%, #ADE0EE 100%);">
                        </div>
                        <div class="ratio-display" id="display_${safeId}">
                            ぽぽ ${popoRatio}% : ぽ ${poRatio}%
                        </div>
                    </div>
                `;
                productList.appendChild(div);
            });
            
            document.getElementById('groupAssignment').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'flex';
        }
        
        function toggleRatioSlider(safeId) {
            const ratioControls = document.getElementById(`ratio_${safeId}`);
            ratioControls.classList.toggle('active');
        }
        
        function updateRatio(product, value) {
            productRatios[product] = parseInt(value);
            const popoRatio = parseInt(value);
            const poRatio = 100 - popoRatio;
            
            const safeId = product.replace(/[^a-zA-Z0-9]/g, '_');
            const display = document.getElementById(`display_${safeId}`);
            const slider = document.getElementById(`slider_${safeId}`);
            
            if (display) {
                display.textContent = `ぽぽ ${popoRatio}% : ぽ ${poRatio}%`;
            }
            
            if (slider) {
                slider.style.background = `linear-gradient(to right, #73C2FB 0%, #73C2FB ${value}%, #ADE0EE ${value}%, #ADE0EE 100%)`;
            }
        }

        function setGroup(product, group) {
            productGroups[product] = group;
            displayProductList(Object.keys(productGroups));
        }

        function calculateResults() {
            document.getElementById('loading').style.display = 'block';
            
            setTimeout(() => {
                const aggregation = {};
                
                csvData.forEach(row => {
                    const productName = row['商品名'];
                    const amount = parseFloat(row['受取金額']) || 0;
                    const subtotal = parseFloat(row['小計']) || 0;
                    const selectedGroup = productGroups[productName] || 1;
                    const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                    const ratioCheckbox = document.getElementById(`ratio_${safeId}`);
                    
                    const isRatioEnabled = ratioCheckbox && ratioCheckbox.classList.contains('active');
                    
                    if (isRatioEnabled) {
                        const ratio = productRatios[productName] || 50;
                        const popoAmount = amount * (ratio / 100);
                        const poAmount = amount * ((100 - ratio) / 100);
                        const popoSubtotal = subtotal * (ratio / 100);
                        const poSubtotal = subtotal * ((100 - ratio) / 100);
                        
                        if (popoAmount > 0 || popoSubtotal > 0) {
                            const popoKey = `${productName}|||1`;
                            if (!aggregation[popoKey]) {
                                aggregation[popoKey] = { product: productName, group: 1, amount: 0, subtotal: 0, count: 0, ratio: ratio, isDivided: true };
                            }
                            if (amount > 0 || subtotal > 0) {
                                aggregation[popoKey].amount += popoAmount;
                                aggregation[popoKey].subtotal += popoSubtotal;
                                aggregation[popoKey].count += 1;
                            }
                        }
                        
                        if (poAmount > 0 || poSubtotal > 0) {
                            const poKey = `${productName}|||2`;
                            if (!aggregation[poKey]) {
                                aggregation[poKey] = { product: productName, group: 2, amount: 0, subtotal: 0, count: 0, ratio: 100 - ratio, isDivided: true };
                            }
                            if (amount > 0 || subtotal > 0) {
                                aggregation[poKey].amount += poAmount;
                                aggregation[poKey].subtotal += poSubtotal;
                                aggregation[poKey].count += 1;
                            }
                        }
                    } else {
                        const key = `${productName}|||${selectedGroup}`;
                        if (!aggregation[key]) {
                            aggregation[key] = { product: productName, group: selectedGroup, amount: 0, subtotal: 0, count: 0, ratio: 100, isDivided: false };
                        }
                        if (amount > 0 || subtotal > 0) {
                            aggregation[key].amount += amount;
                            aggregation[key].subtotal += subtotal;
                            aggregation[key].count += 1;
                        }
                    }
                });
                
                results = Object.values(aggregation)
                    .filter(r => r.amount > 0 || r.subtotal > 0)
                    .sort((a, b) => {
                        if (a.group !== b.group) return a.group - b.group;
                        return b.amount - a.amount;
                    });
                
                displayResults();
                document.getElementById('loading').style.display = 'none';
            }, 500);
        }

        function displayResults() {
            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;
            
            // 最新月を特定
            const allMonthsSet = new Set();
            csvData.forEach(row => {
                const rawDate = (row['注文日時'] || '').split(' ')[0];
                if (!rawDate) return;
                const dateStr = rawDate.replace(/\//g, '-');
                const monthStr = dateStr.substring(0, 7);
                allMonthsSet.add(monthStr);
            });
            
            const allMonths = Array.from(allMonthsSet).sort();
            const latestMonth = allMonths[allMonths.length - 1] || '';
            
            // 全期間のデータで集計（青いカードは今まで通り）
            const group1Results = results.filter(r => r.group === 1);
            const group2Results = results.filter(r => r.group === 2);

            const group1Total = group1Results.reduce((sum, r) => sum + r.amount, 0);
            const group2Total = group2Results.reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = group1Total + group2Total;

            const group1Subtotal = group1Results.reduce((sum, r) => sum + r.subtotal, 0);
            const group2Subtotal = group2Results.reduce((sum, r) => sum + r.subtotal, 0);
            const grandSubtotal = group1Subtotal + group2Subtotal;

            const group1BoothFee = group1Subtotal - group1Total;
            const group2BoothFee = group2Subtotal - group2Total;
            const grandBoothFee = grandSubtotal - grandTotal;

            const group1Count = group1Results.reduce((sum, r) => sum + r.count, 0);
            const group2Count = group2Results.reduce((sum, r) => sum + r.count, 0);
            const grandCount = group1Count + group2Count;

            const group1Ratio = grandTotal > 0 ? group1Total / grandTotal : 0;
            const group2Ratio = grandTotal > 0 ? group2Total / grandTotal : 0;
            
            const group1Fee = transferFee * group1Ratio;
            const group2Fee = transferFee * group2Ratio;
            
            const group1Net = group1Total - group1Fee;
            const group2Net = group2Total - group2Fee;

            const cardStyle = `style="margin-top: 15px; padding: 10px 20px; background: white; color: #73C2FB; border: 2px solid white; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.9)'" onmouseout="this.style.background='white'"`;
            const dividerStyle = `style="border-top: 1px solid rgba(255,255,255,0.3); margin: 12px 0;"`;
            const rowStyle = `style="display:flex; justify-content:space-between; padding: 3px 0; font-size:0.9em;"`;
            const labelStyle = `style="opacity:0.85;"`;
            const valueStyle = `style="font-weight:600;"`;

            const summaryCards = document.getElementById('summaryCards');
            summaryCards.innerHTML = `
                <div class="result-card">
                    <h3>ぽぽ${latestMonth ? `（${latestMonth}）` : ''}</h3>
                    <div class="result-amount">¥${Math.floor(group1Net).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(group1Subtotal).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料</span><span ${valueStyle}>-¥${Math.floor(Math.abs(group1BoothFee)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(group1Total).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>販売件数</span><span ${valueStyle}>${group1Count}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>商品数</span><span ${valueStyle}>${group1Results.length}商品</span></div>
                    <div ${rowStyle}><span ${labelStyle}>売上割合</span><span ${valueStyle}>${(group1Ratio * 100).toFixed(1)}%</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料</span><span ${valueStyle}>-¥${Math.round(group1Fee).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(group1Net).toLocaleString()}</span></div>
                    <button onclick="downloadGroupCSV(1)" ${cardStyle}>CSVを保存</button>
                </div>
                <div class="result-card">
                    <h3>ぽ${latestMonth ? `（${latestMonth}）` : ''}</h3>
                    <div class="result-amount">¥${Math.floor(group2Net).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(group2Subtotal).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料</span><span ${valueStyle}>-¥${Math.floor(Math.abs(group2BoothFee)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(group2Total).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>販売件数</span><span ${valueStyle}>${group2Count}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>商品数</span><span ${valueStyle}>${group2Results.length}商品</span></div>
                    <div ${rowStyle}><span ${labelStyle}>売上割合</span><span ${valueStyle}>${(group2Ratio * 100).toFixed(1)}%</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料</span><span ${valueStyle}>-¥${Math.round(group2Fee).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(group2Net).toLocaleString()}</span></div>
                    <button onclick="downloadGroupCSV(2)" ${cardStyle}>CSVを保存</button>
                </div>
                <div class="result-card">
                    <h3>総合計${latestMonth ? `（${latestMonth}）` : ''}</h3>
                    <div class="result-amount">¥${Math.floor(grandTotal - transferFee).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(grandSubtotal).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料</span><span ${valueStyle}>-¥${Math.floor(Math.abs(grandBoothFee)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(grandTotal).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>総販売件数</span><span ${valueStyle}>${grandCount}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>総商品数</span><span ${valueStyle}>${results.length}商品</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料</span><span ${valueStyle}>-¥${transferFee.toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(grandTotal - transferFee).toLocaleString()}</span></div>
                    <button onclick="downloadResultsSummary()" ${cardStyle}>集計結果を保存</button>
                </div>
            `;
            
            // 詳細テーブル
            let tableHTML = `
                <thead>
                    <tr>
                        <th>グループ</th>
                        <th>商品名</th>
                        <th>分配割合</th>
                        <th>販売数</th>
                        <th>受取金額合計</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            results.forEach(result => {
                const ratioText = result.isDivided ? `${result.ratio}%` : '100%';
                tableHTML += `
                    <tr>
                        <td>${result.group === 1 ? 'ぽぽ' : 'ぽ'}</td>
                        <td class="clickable-product" onclick="showProductDetail('${result.product.replace(/'/g, "\\'")}', ${result.group})">${result.product}</td>
                        <td>${ratioText}</td>
                        <td>${result.count}件</td>
                        <td class="amount-cell">¥${Math.floor(result.amount).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            document.getElementById('detailsTable').innerHTML = tableHTML;
            document.getElementById('results').style.display = 'block';

            // 日別売上を計算・準備
            prepareDailySales();

            // 月別比較を表示
            displayMonthlyComparison();

            // グラフを描画
            buildChartData();
            document.getElementById('chartSection').style.display = 'block';
            renderDailyChart();
            renderMonthlyChart();
            renderForecastChart();
        }

        function prepareDailySales() {
            // 最新月のデータのみで日別売上を計算
            const allMonthData = {};
            csvData.forEach(row => {
                const rawDate = (row['注文日時'] || '').split(' ')[0];
                if (!rawDate) return;
                const dateStr = rawDate.replace(/\//g, '-');
                const monthStr = dateStr.substring(0, 7);
                if (!allMonthData[monthStr]) allMonthData[monthStr] = [];
                allMonthData[monthStr].push(row);
            });
            
            const allMonths = Object.keys(allMonthData).sort();
            const latestMonth = allMonths[allMonths.length - 1];
            const latestMonthRows = allMonthData[latestMonth] || csvData;
            
            // 日別集計
            const dailyData = {};
            latestMonthRows.forEach(row => {
                const productName = row['商品名'];
                const amount = parseFloat(row['受取金額']) || 0;
                const rawDate = (row['注文日時'] || '').split(' ')[0];
                if (!rawDate) return;
                const dateStr = rawDate.replace(/\//g, '-');
                
                const selectedGroup = productGroups[productName] || 1;
                const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                const ratioEl = document.getElementById(`ratio_${safeId}`);
                const isRatioEnabled = ratioEl && ratioEl.classList.contains('active');
                
                let popoAmt = 0, poAmt = 0;
                if (isRatioEnabled) {
                    const ratio = productRatios[productName] || 50;
                    popoAmt = amount * (ratio / 100);
                    poAmt = amount * ((100 - ratio) / 100);
                } else {
                    if (selectedGroup === 1) popoAmt = amount;
                    else poAmt = amount;
                }
                
                if (!dailyData[dateStr]) dailyData[dateStr] = { popo: 0, po: 0 };
                dailyData[dateStr].popo += popoAmt;
                dailyData[dateStr].po += poAmt;
            });
            
            // 日付順にソート（新しい順）
            const sortedDates = Object.keys(dailyData).sort().reverse();
            
            // HTML生成
            let popoHTML = '';
            let poHTML = '';
            let totalHTML = '';
            
            sortedDates.forEach(date => {
                const d = dailyData[date];
                const popo = Math.floor(d.popo);
                const po = Math.floor(d.po);
                const total = popo + po;
                
                popoHTML += `<div class="daily-sales-item"><span class="daily-sales-date">${date}</span><span class="daily-sales-amount">¥${popo.toLocaleString()}</span></div>`;
                poHTML += `<div class="daily-sales-item"><span class="daily-sales-date">${date}</span><span class="daily-sales-amount">¥${po.toLocaleString()}</span></div>`;
                totalHTML += `<div class="daily-sales-item"><span class="daily-sales-date">${date}</span><span class="daily-sales-amount">¥${total.toLocaleString()}</span></div>`;
            });
            
            const contentHTML = `
                <div class="daily-sales-grid">
                    <div class="daily-sales-column popo">
                        <h4>ぽぽ</h4>
                        ${popoHTML}
                    </div>
                    <div class="daily-sales-column po">
                        <h4>ぽ</h4>
                        ${poHTML}
                    </div>
                    <div class="daily-sales-column total">
                        <h4>合計</h4>
                        ${totalHTML}
                    </div>
                </div>
            `;
            
            document.getElementById('dailySalesContent').innerHTML = contentHTML;
            document.getElementById('dailySalesSection').style.display = 'block';
        }

        function toggleDailySales() {
            const content = document.getElementById('dailySalesContent');
            const btn = document.getElementById('dailySalesToggleBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = '隠す';
            } else {
                content.style.display = 'none';
                btn.textContent = '表示';
            }
        }

        function downloadResultsSummary() {
            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;
            
            let csv = 'グループ,商品名,分配割合,販売数,受取金額合計\n';
            
            results.forEach(result => {
                const groupName = result.group === 1 ? 'ぽぽ' : 'ぽ';
                const ratioText = result.isDivided ? `${result.ratio}%` : '100%';
                csv += `${groupName},"${result.product}",${ratioText},${result.count},${Math.floor(result.amount)}\n`;
            });
            
            // サマリー行を追加
            const group1Total = results.filter(r => r.group === 1).reduce((sum, r) => sum + r.amount, 0);
            const group2Total = results.filter(r => r.group === 2).reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = group1Total + group2Total;
            
            const group1Ratio = grandTotal > 0 ? group1Total / grandTotal : 0;
            const group2Ratio = grandTotal > 0 ? group2Total / grandTotal : 0;
            
            const group1Fee = Math.round(transferFee * group1Ratio);
            const group2Fee = Math.round(transferFee * group2Ratio);
            
            const group1Net = group1Total - group1Fee;
            const group2Net = group2Total - group2Fee;
            
            csv += '\n集計サマリー\n';
            csv += `ぽぽ合計,,${results.filter(r => r.group === 1).reduce((sum, r) => sum + r.count, 0)},${group1Total}\n`;
            csv += `ぽぽ売上割合,,,${(group1Ratio * 100).toFixed(1)}%\n`;
            csv += `ぽぽ振込手数料負担,,,-${group1Fee}\n`;
            csv += `ぽぽ受取金額,,,${Math.floor(group1Net)}\n`;
            csv += '\n';
            csv += `ぽ合計,,${results.filter(r => r.group === 2).reduce((sum, r) => sum + r.count, 0)},${group2Total}\n`;
            csv += `ぽ売上割合,,,${(group2Ratio * 100).toFixed(1)}%\n`;
            csv += `ぽ振込手数料負担,,,-${group2Fee}\n`;
            csv += `ぽ受取金額,,,${Math.floor(group2Net)}\n`;
            csv += '\n';
            csv += `総合計,,${results.reduce((sum, r) => sum + r.count, 0)},${grandTotal}\n`;
            csv += `振込手数料合計,,,-${transferFee}\n`;
            csv += `受取金額,,,${Math.floor(grandTotal - transferFee)}\n`;
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${originalFileName}_集計結果.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function downloadGroupCSV(group) {
            if (csvData.length === 0) {
                alert('まずCSVファイルを読み込んでください');
                return;
            }
            
            const groupName = group === 1 ? 'ぽぽ' : 'ぽ';
            
            // ヘッダー行を取得（元のCSVと同じ順序）
            const headers = Object.keys(csvData[0]);
            
            // グループに属する商品のデータのみフィルタリング
            const groupData = csvData.filter(row => {
                const productName = row['商品名'];
                const amount = parseFloat(row['受取金額']) || 0;
                
                if (amount > 0) {
                    const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                    const ratioControls = document.getElementById(`ratio_${safeId}`);
                    const isRatioEnabled = ratioControls && ratioControls.classList.contains('active');
                    
                    if (isRatioEnabled) {
                        // 分配設定がある場合は割合に応じて判定
                        const ratio = productRatios[productName] || 50;
                        const popoRatio = ratio;
                        const poRatio = 100 - ratio;
                        
                        if (group === 1) {
                            return popoRatio > 0;
                        } else {
                            return poRatio > 0;
                        }
                    } else {
                        // 分配設定がない場合は選択グループのみ
                        const selectedGroup = productGroups[productName] || 1;
                        return selectedGroup === group;
                    }
                }
                return false;
            });
            
            if (groupData.length === 0) {
                alert(`${groupName}に割り当てられた商品がありません`);
                return;
            }
            
            // CSV文字列を生成
            let csv = '';
            
            // ヘッダー行（分配割合と分配後金額を追加）
            csv += headers.map(h => `"${h}"`).join(',') + ',"利益分配割合","分配後受取金額"\n';
            
            // データ行
            groupData.forEach(row => {
                const productName = row['商品名'];
                const originalAmount = parseFloat(row['受取金額']) || 0;
                const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                const ratioControls = document.getElementById(`ratio_${safeId}`);
                const isRatioEnabled = ratioControls && ratioControls.classList.contains('active');
                
                let groupRatio, distributedAmount, ratioLabel;
                
                if (isRatioEnabled) {
                    // 分配設定がある場合
                    const ratio = productRatios[productName] || 50;
                    groupRatio = group === 1 ? ratio : (100 - ratio);
                    distributedAmount = Math.floor(originalAmount * (groupRatio / 100));
                    ratioLabel = `${groupName} ${groupRatio}%`;
                } else {
                    // 分配設定がない場合は100%
                    groupRatio = 100;
                    distributedAmount = originalAmount;
                    ratioLabel = `${groupName} 100%`;
                }
                
                const values = headers.map(header => {
                    const value = row[header] || '';
                    // 値にカンマや改行が含まれる場合はダブルクォートで囲む
                    if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return `"${value}"`;
                });
                csv += values.join(',') + `,"${ratioLabel}","${distributedAmount}"\n`;
            });
            
            // 合計行を追加
            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;
            const group1Total = results.filter(r => r.group === 1).reduce((sum, r) => sum + r.amount, 0);
            const group2Total = results.filter(r => r.group === 2).reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = group1Total + group2Total;
            
            const groupTotal = group === 1 ? group1Total : group2Total;
            const groupRatio = grandTotal > 0 ? groupTotal / grandTotal : 0;
            const groupFee = Math.round(transferFee * groupRatio);
            const groupNet = groupTotal - groupFee;
            const groupCount = groupData.reduce((sum, row) => {
                const amount = parseFloat(row['受取金額']) || 0;
                return amount > 0 ? sum + 1 : sum;
            }, 0);
            
            csv += '\n';
            csv += `"${groupName} 集計サマリー"\n`;
            csv += `"販売数","${groupCount}件"\n`;
            csv += `"受取金額合計","${groupTotal}円"\n`;
            csv += `"売上割合","${(groupRatio * 100).toFixed(1)}%"\n`;
            csv += `"振込手数料負担","-${groupFee}円"\n`;
            csv += `"受取金額","${Math.floor(groupNet)}円"\n`;
            
            // ダウンロード
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${originalFileName}_${groupName}合計.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function copyResultsAsText() {
            if (results.length === 0) {
                alert('まず集計を実行してください');
                return;
            }
            
            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;
            
            // 集計データを計算
            const group1Total = results.filter(r => r.group === 1).reduce((sum, r) => sum + r.amount, 0);
            const group2Total = results.filter(r => r.group === 2).reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = group1Total + group2Total;
            
            const group1Ratio = grandTotal > 0 ? group1Total / grandTotal : 0;
            const group2Ratio = grandTotal > 0 ? group2Total / grandTotal : 0;
            
            const group1Fee = Math.round(transferFee * group1Ratio);
            const group2Fee = Math.round(transferFee * group2Ratio);
            
            const group1Net = group1Total - group1Fee;
            const group2Net = group2Total - group2Fee;
            
            // テキスト生成
            let text = '━━━━━━━━━━━━━━━━━━━━\n';
            text += '売上集計結果\n';
            text += '━━━━━━━━━━━━━━━━━━━━\n\n';
            
            // ぽぽの集計
            text += '【ぽぽ】\n';
            text += `売上合計: ¥${group1Total.toLocaleString()}\n`;
            text += `売上割合: ${(group1Ratio * 100).toFixed(1)}%\n`;
            text += `振込手数料: -¥${group1Fee.toLocaleString()}\n`;
            text += `受取金額: ¥${Math.floor(group1Net).toLocaleString()}\n`;
            text += `商品数: ${results.filter(r => r.group === 1).length}商品\n\n`;
            
            // ぽぽの商品詳細
            const group1Items = results.filter(r => r.group === 1);
            if (group1Items.length > 0) {
                text += '＜商品詳細＞\n';
                group1Items.forEach(item => {
                    text += `  • ${item.product}\n`;
                    text += `    販売数: ${item.count}件 / 金額: ¥${item.amount.toLocaleString()}\n`;
                });
                text += '\n';
            }
            
            text += '━━━━━━━━━━━━━━━━━━━━\n\n';
            
            // ぽの集計
            text += '【ぽ】\n';
            text += `売上合計: ¥${group2Total.toLocaleString()}\n`;
            text += `売上割合: ${(group2Ratio * 100).toFixed(1)}%\n`;
            text += `振込手数料: -¥${group2Fee.toLocaleString()}\n`;
            text += `受取金額: ¥${Math.floor(group2Net).toLocaleString()}\n`;
            text += `商品数: ${results.filter(r => r.group === 2).length}商品\n\n`;
            
            // ぽの商品詳細
            const group2Items = results.filter(r => r.group === 2);
            if (group2Items.length > 0) {
                text += '＜商品詳細＞\n';
                group2Items.forEach(item => {
                    text += `  • ${item.product}\n`;
                    text += `    販売数: ${item.count}件 / 金額: ¥${item.amount.toLocaleString()}\n`;
                });
                text += '\n';
            }
            
            text += '━━━━━━━━━━━━━━━━━━━━\n\n';
            
            // 総合計
            text += '【総合計】\n';
            text += `総売上: ¥${grandTotal.toLocaleString()}\n`;
            text += `振込手数料: -¥${transferFee.toLocaleString()}\n`;
            text += `受取金額: ¥${Math.floor(grandTotal - transferFee).toLocaleString()}\n`;
            text += `総商品数: ${results.length}商品\n`;
            text += `総販売数: ${results.reduce((sum, r) => sum + r.count, 0)}件\n`;
            
            // クリップボードにコピー
            navigator.clipboard.writeText(text).then(() => {
                showCopyNotification();
            }).catch(err => {
                // フォールバック: テキストエリアを使った古い方法
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showCopyNotification();
            });
        }
        
        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function showProductDetail(productName, group) {
            // 該当商品のデータを取得
            const productDetails = csvData.filter(row => row['商品名'] === productName);
            
            if (productDetails.length === 0) {
                alert('商品データが見つかりません');
                return;
            }
            
            // 合計を計算
            const totalAmount = productDetails.reduce((sum, row) => sum + (parseFloat(row['受取金額']) || 0), 0);
            const totalCount = productDetails.length;
            
            // モーダルのタイトルを設定
            document.getElementById('modalProductName').textContent = productName;
            
            // モーダルの内容を生成
            let modalContent = `
                <div class="detail-summary">
                    <div class="detail-summary-item">
                        <span>グループ:</span>
                        <span><strong>${group === 1 ? 'ぽぽ' : 'ぽ'}</strong></span>
                    </div>
                    <div class="detail-summary-item">
                        <span>総販売数:</span>
                        <span><strong>${totalCount}件</strong></span>
                    </div>
                    <div class="detail-summary-item">
                        <span>受取金額合計:</span>
                        <span><strong>¥${totalAmount.toLocaleString()}</strong></span>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: #333;">注文詳細</h3>
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>注文日時</th>
                            <th>注文番号</th>
                            <th>バリエーション</th>
                            <th>単価</th>
                            <th>数量</th>
                            <th>受取金額</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 注文データを日付順にソート
            productDetails.sort((a, b) => {
                return new Date(b['注文日時']) - new Date(a['注文日時']);
            });
            
            productDetails.forEach(row => {
                const orderDate = row['注文日時'] || '-';
                const orderNumber = row['注文番号'] || '-';
                const variation = row['バリエーション名'] || '-';
                const price = row['単価'] || '0';
                const quantity = row['数量'] || '0';
                const amount = parseFloat(row['受取金額']) || 0;
                
                modalContent += `
                    <tr>
                        <td>${orderDate}</td>
                        <td>${orderNumber}</td>
                        <td>${variation}</td>
                        <td>¥${parseFloat(price).toLocaleString()}</td>
                        <td>${quantity}</td>
                        <td style="font-weight: 600; color: #28a745;">¥${amount.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            modalContent += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('modalBody').innerHTML = modalContent;
            document.getElementById('detailModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        // モーダル外をクリックしたら閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ====== グラフ関連 ======
        let chartInstances = {};
        let chartData = { daily: {}, monthly: {} };

        function switchTab(name) {
            document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.chart-panel').forEach(p => p.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(`panel-${name}`).classList.add('active');
        }

        function buildChartData() {
            const daily = {};
            const monthly = {};

            csvData.forEach(row => {
                const productName = row['商品名'];
                const amount = parseFloat(row['受取金額']) || 0;
                if (amount <= 0) return;

                const rawDate = (row['注文日時'] || '').split(' ')[0];
                if (!rawDate) return;
                // YYYY/MM/DD と YYYY-MM-DD 両方に対応して YYYY-MM-DD 形式に正規化
                const dateStr = rawDate.replace(/\//g, '-');
                const monthStr = dateStr.substring(0, 7); // YYYY-MM

                const selectedGroup = productGroups[productName] || 1;
                const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                const ratioEl = document.getElementById(`ratio_${safeId}`);
                const isRatioEnabled = ratioEl && ratioEl.classList.contains('active');

                let popoAmt = 0, poAmt = 0;
                if (isRatioEnabled) {
                    const ratio = productRatios[productName] || 50;
                    popoAmt = amount * (ratio / 100);
                    poAmt   = amount * ((100 - ratio) / 100);
                } else {
                    if (selectedGroup === 1) popoAmt = amount;
                    else poAmt = amount;
                }

                if (!daily[dateStr]) daily[dateStr] = { popo: 0, po: 0 };
                daily[dateStr].popo += popoAmt;
                daily[dateStr].po   += poAmt;

                if (!monthly[monthStr]) monthly[monthStr] = { popo: 0, po: 0 };
                monthly[monthStr].popo += popoAmt;
                monthly[monthStr].po   += poAmt;
            });

            chartData.daily   = daily;
            chartData.monthly = monthly;
        }

        function renderDailyChart() {
            const showPopo  = document.getElementById('daily-popo').checked;
            const showPo    = document.getElementById('daily-po').checked;
            const showTotal = document.getElementById('daily-total').checked;

            const labels = Object.keys(chartData.daily).sort();
            const popoVals  = labels.map(d => Math.floor(chartData.daily[d].popo));
            const poVals    = labels.map(d => Math.floor(chartData.daily[d].po));
            const totalVals = labels.map(d => Math.floor(chartData.daily[d].popo + chartData.daily[d].po));

            const datasets = [];
            if (showPopo)  datasets.push({ label: 'ぽぽ', data: popoVals,  borderColor: '#73C2FB', backgroundColor: 'rgba(115,194,251,0.15)', tension: 0.3, fill: true, pointRadius: 3 });
            if (showPo)    datasets.push({ label: 'ぽ',   data: poVals,    borderColor: '#ADE0EE', backgroundColor: 'rgba(173,224,238,0.15)', tension: 0.3, fill: true, pointRadius: 3 });
            if (showTotal) datasets.push({ label: '合計', data: totalVals, borderColor: '#5AB3F5', backgroundColor: 'rgba(90,179,245,0.08)',  tension: 0.3, fill: false, borderDash: [5,3], pointRadius: 3 });

            drawChart('dailyChart', 'line', labels, datasets);
        }

        function renderMonthlyChart() {
            const showPopo  = document.getElementById('monthly-popo').checked;
            const showPo    = document.getElementById('monthly-po').checked;
            const showTotal = document.getElementById('monthly-total').checked;

            const labels = Object.keys(chartData.monthly).sort();
            const popoVals  = labels.map(m => Math.floor(chartData.monthly[m].popo));
            const poVals    = labels.map(m => Math.floor(chartData.monthly[m].po));
            const totalVals = labels.map(m => Math.floor(chartData.monthly[m].popo + chartData.monthly[m].po));

            const datasets = [];
            if (showPopo)  datasets.push({ label: 'ぽぽ', data: popoVals,  backgroundColor: 'rgba(115,194,251,0.7)', borderColor: '#73C2FB', borderWidth: 2 });
            if (showPo)    datasets.push({ label: 'ぽ',   data: poVals,    backgroundColor: 'rgba(173,224,238,0.8)', borderColor: '#ADE0EE', borderWidth: 2 });
            if (showTotal) datasets.push({ label: '合計', data: totalVals, backgroundColor: 'rgba(90,179,245,0.35)', borderColor: '#5AB3F5', borderWidth: 2 });

            drawChart('monthlyChart', 'bar', labels, datasets);
        }

        function renderForecastChart() {
            const target = document.querySelector('input[name="forecast-group"]:checked').value;
            const months = parseInt(document.getElementById('forecastMonths').value);
            const monthKeys = Object.keys(chartData.monthly).sort();
            if (monthKeys.length === 0) return;

            const actualVals = monthKeys.map(m => {
                const d = chartData.monthly[m];
                if (target === 'popo') return Math.floor(d.popo);
                if (target === 'po')   return Math.floor(d.po);
                return Math.floor(d.popo + d.po);
            });

            // 線形回帰
            const n = actualVals.length;
            const xs = actualVals.map((_, i) => i);
            const meanX = xs.reduce((a, b) => a + b, 0) / n;
            const meanY = actualVals.reduce((a, b) => a + b, 0) / n;
            const denom = xs.reduce((s, x) => s + (x - meanX) ** 2, 0);
            const slope = denom === 0 ? 0 :
                xs.reduce((s, x, i) => s + (x - meanX) * (actualVals[i] - meanY), 0) / denom;
            const intercept = meanY - slope * meanX;

            // 予測月を生成（安全なパース）
            const lastKey = monthKeys[monthKeys.length - 1];
            const parts = lastKey.split('-');
            const ly = parseInt(parts[0], 10);
            const lm = parseInt(parts[1], 10);
            if (isNaN(ly) || isNaN(lm)) return;

            const forecastLabels = [];
            const forecastVals   = [];
            for (let i = 1; i <= months; i++) {
                let nm = lm + i;
                let ny = ly + Math.floor((nm - 1) / 12);
                nm = ((nm - 1) % 12) + 1;
                forecastLabels.push(`${ny}-${String(nm).padStart(2,'0')}`);
                const predicted = intercept + slope * (n - 1 + i);
                forecastVals.push(Math.max(0, Math.round(isNaN(predicted) ? meanY : predicted)));
            }

            const allLabels    = [...monthKeys, ...forecastLabels];
            const actualData   = [...actualVals, ...Array(months).fill(null)];
            const forecastData = [...Array(n - 1).fill(null), actualVals[n - 1], ...forecastVals];

            const targetLabel = target === 'popo' ? 'ぽぽ' : target === 'po' ? 'ぽ' : '合計';
            drawChart('forecastChart', 'line', allLabels, [
                { label: `${targetLabel}（実績）`, data: actualData,   borderColor: '#73C2FB', backgroundColor: 'rgba(115,194,251,0.15)', tension: 0.3, fill: true,  pointRadius: 4 },
                { label: `${targetLabel}（予測）`, data: forecastData, borderColor: '#F5A623', backgroundColor: 'rgba(245,166,35,0.1)',    tension: 0.3, fill: false, borderDash: [6,4], pointRadius: 4 },
            ]);

            const trend = isNaN(slope) || slope === 0 ? '横ばい傾向'
                : slope >= 0 ? `月約 ¥${Math.round(slope).toLocaleString()} の増加傾向`
                             : `月約 ¥${Math.abs(Math.round(slope)).toLocaleString()} の減少傾向`;
            const nextVal = forecastVals[0] ?? 0;
            document.getElementById('forecastNote').innerHTML =
                `<strong>予測について：</strong>過去 ${n} ヶ月の実績をもとに線形回帰で算出。${trend}が見られます。来月の予測は <strong>¥${nextVal.toLocaleString()}</strong> です。データ数が少ない場合や季節変動がある場合は参考値としてご利用ください。`;
        }

        function drawChart(id, type, labels, datasets) {
            if (chartInstances[id]) chartInstances[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            chartInstances[id] = new Chart(ctx, {
                type,
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { callbacks: { label: c => ` ¥${(c.parsed.y ?? 0).toLocaleString()}` } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => '¥' + v.toLocaleString() } }
                    }
                }
            });
        }
        // ====== グラフ関連ここまで ======
    </script>
</body>
</html>
