<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>売上集計ツール</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ADE0EE 0%, #73C2FB 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 2em;
        }
        
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #73C2FB;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #73C2FB;
            background: #ADE0EE;
        }
        
        .file-row {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border-radius: 8px;
            padding: 10px 15px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }
        
        .file-row .file-label-small {
            display: inline-block;
            padding: 7px 16px;
            background: #73C2FB;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
            transition: all 0.3s;
        }
        
        .file-row .file-label-small:hover {
            background: #5AB3F5;
        }
        
        .file-row .file-name-inline {
            flex: 1;
            color: #555;
            font-size: 0.9em;
            text-align: left;
        }
        
        .file-row .remove-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.3em;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .file-row .remove-btn:hover {
            color: #e74c3c;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
        
        input[type="file"] {
            position: absolute;
            left: -9999px;
        }
        
        label.file-label {
            display: inline-block;
            padding: 12px 30px;
            background: #73C2FB;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        label.file-label:hover {
            background: #5AB3F5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(115, 194, 251, 0.4);
        }
        
        .file-name {
            display: block;
            margin-top: 10px;
            color: #555;
            font-size: 0.9em;
        }
        
        .group-assignment {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }
        
        .group-assignment h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .product-group-item {
            display: flex;
            flex-direction: column;
            padding: 20px;
            background: white;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .product-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .ratio-controls {
            display: none;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-top: 10px;
        }
        
        .ratio-controls.active {
            display: flex;
        }
        
        .ratio-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #666;
            cursor: pointer;
            padding: 5px 0;
        }
        
        .ratio-toggle input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
        
        .ratio-slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ratio-slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            background: linear-gradient(to right, #667eea 0%, #667eea 50%, #764ba2 50%, #764ba2 100%);
        }
        
        .ratio-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid #73C2FB;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .ratio-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid #73C2FB;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .ratio-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .ratio-display {
            font-weight: 600;
            color: #333;
            min-width: 120px;
            text-align: center;
            background: white;
            padding: 8px 15px;
            border-radius: 6px;
            border: 2px solid #73C2FB;
        }
        
        .product-name {
            flex: 1;
            font-weight: 500;
            color: #333;
            margin-right: 20px;
        }
        
        .group-selector {
            display: flex;
            gap: 10px;
        }
        
        .group-btn {
            padding: 8px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .group-btn:hover {
            border-color: #73C2FB;
        }
        
        .group-btn.active {
            background: #73C2FB;
            color: white;
            border-color: #73C2FB;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .button-row {
            display: flex;
            gap: 20px;
        }
        
        button {
            padding: 14px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #73C2FB;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5AB3F5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(115, 194, 251, 0.4);
        }
        
        .btn-secondary {
            background: #ADE0EE;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #9AD6E6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(173, 224, 238, 0.4);
        }
        
        .btn-copy {
            background: #73C2FB;
            color: white;
        }
        
        .btn-copy:hover {
            background: #5AB3F5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(115, 194, 251, 0.4);
        }
        
        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideUp 0.3s;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #73C2FB 0%, #ADE0EE 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
            max-height: calc(80vh - 100px);
            overflow-y: auto;
        }
        
        .detail-summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .detail-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .detail-summary-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.1em;
            color: #73C2FB;
        }
        
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .detail-table th {
            background: #73C2FB;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .detail-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-table tr:hover {
            background: #f8f9fa;
        }
        
        .clickable-product {
            cursor: pointer;
            color: #73C2FB;
            transition: all 0.3s;
        }
        
        .clickable-product:hover {
            color: #5AB3F5;
            text-decoration: underline;
        }
        
        .results {
            display: none;
        }
        
        .results h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-card {
            background: linear-gradient(135deg, #73C2FB 0%, #ADE0EE 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .result-card h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .result-amount {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .result-detail {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: #73C2FB;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .amount-cell {
            font-weight: 600;
            color: #28a745;
            text-align: right;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            display: none;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="copy-notification" id="copyNotification">
        クリップボードにコピーしました
    </div>
    
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalProductName"></h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>
    
    <div class="container">
        <h1>売上集計ツール</h1>
        
        <div class="upload-section">
            <div id="fileInputList" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;"></div>
            <button class="btn-primary" onclick="addFileInput()" style="padding: 10px 25px; font-size: 0.95em;">CSVファイルを追加</button>
        </div>
        
        <div class="group-assignment" id="groupAssignment">
            <h2>商品のグループ分け</h2>
            <div id="productList"></div>
        </div>
        
        <div class="action-buttons" id="actionButtons" style="display: none;">
            <div style="margin-bottom: 10px; text-align: center;">
                <label style="font-size: 1.1em; font-weight: 600; color: #333; margin-right: 10px;">
                    振込手数料:
                </label>
                <input type="number" id="transferFee" value="200" 
                       style="padding: 10px 20px; border: 2px solid #73C2FB; border-radius: 6px; font-size: 1em; width: 150px; text-align: right;">
                <span style="margin-left: 5px; color: #666;">円</span>
            </div>
            <div class="button-row">
                <button class="btn-primary" onclick="calculateResults()">集計実行</button>
                <button class="btn-copy" onclick="copyResultsAsText()">テキストコピー</button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>集計中...</p>
        </div>
        
        <div class="results" id="results">
            <h2>集計結果</h2>
            <div class="results-grid" id="summaryCards"></div>
            <table id="detailsTable"></table>
        </div>
    </div>

    <script>
        let csvData = [];
        let productGroups = {};
        let productRatios = {};
        let results = [];
        let rawDataMap = {}; // fileId -> rows
        let fileCounter = 0;
        let fileNames = [];

        // 初期化：最初の1行を自動追加
        window.addEventListener('DOMContentLoaded', () => addFileInput());

        function addFileInput() {
            fileCounter++;
            const id = fileCounter;
            const container = document.getElementById('fileInputList');

            const row = document.createElement('div');
            row.className = 'file-row';
            row.id = `fileRow_${id}`;

            row.innerHTML = `
                <input type="file" id="csvInput_${id}" accept=".csv" style="display:none;">
                <label for="csvInput_${id}" class="file-label-small">ファイル ${id} を選択</label>
                <span class="file-name-inline" id="fileNameLabel_${id}">選択されていません</span>
                <button class="remove-btn" onclick="removeFileInput(${id})" title="削除">&times;</button>
            `;

            container.appendChild(row);

            document.getElementById(`csvInput_${id}`).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                document.getElementById(`fileNameLabel_${id}`).textContent = file.name;
                readFileIntoMap(file, id);
            });
        }

        function removeFileInput(id) {
            const row = document.getElementById(`fileRow_${id}`);
            if (row) row.remove();
            delete rawDataMap[id];
            rebuildCsvData();
        }

        function readFileIntoMap(file, id) {
            const reader = new FileReader();
            reader.onload = function(e) {
                rawDataMap[id] = { name: file.name.replace('.csv', ''), rows: parseCSVToRows(e.target.result) };
                rebuildCsvData();
            };
            reader.readAsText(file, 'UTF-8');
        }

        // 商品IDごとの代表名（最初に登場した名前を使用）
        let productIdToName = {};

        function rebuildCsvData() {
            csvData = [];
            fileNames = [];
            Object.values(rawDataMap).forEach(f => {
                csvData = csvData.concat(f.rows);
                fileNames.push(f.name);
            });
            originalFileName = fileNames.join('_');

            // 商品IDで名前を統一（最初に登場した名前を代表名にする）
            csvData.forEach(row => {
                const pid = row['商品ID'];
                if (pid && !productIdToName[pid]) {
                    productIdToName[pid] = row['商品名'];
                }
            });

            // 全行の商品名を代表名に統一
            csvData.forEach(row => {
                const pid = row['商品ID'];
                if (pid && productIdToName[pid]) {
                    row['商品名'] = productIdToName[pid];
                }
            });

            const uniqueProducts = new Set();
            csvData.forEach(row => uniqueProducts.add(row['商品名']));

            // 新商品だけデフォルト設定（既存設定は保持）
            uniqueProducts.forEach(product => {
                if (productGroups[product] === undefined) productGroups[product] = 1;
                if (productRatios[product] === undefined) productRatios[product] = 50;
            });

            displayProductList(Array.from(uniqueProducts));
        }

        function parseCSVToRows(text) {
            const lines = text.split('\n');
            const headers = parseCSVLine(lines[0]);
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length >= headers.length) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.replace(/^\uFEFF/, '').trim()] = values[index];
                        });
                        if (!row['受取金額'] || row['受取金額'].trim() === '') {
                            row['受取金額'] = '0';
                        }
                        rows.push(row);
                    }
                }
            }
            return rows;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            
            return result.map(v => v.replace(/^"|"$/g, ''));
        }

        function displayProductList(products) {
            const productList = document.getElementById('productList');
            productList.innerHTML = '';
            
            products.sort().forEach(product => {
                const ratio = productRatios[product] || 50;
                const popoRatio = ratio;
                const poRatio = 100 - ratio;
                const safeId = product.replace(/[^a-zA-Z0-9]/g, '_');
                
                const div = document.createElement('div');
                div.className = 'product-group-item';
                div.innerHTML = `
                    <div class="product-row">
                        <div class="product-name">${product}</div>
                        <div class="group-selector">
                            <button class="group-btn ${productGroups[product] === 1 ? 'active' : ''}" 
                                    onclick="setGroup('${product.replace(/'/g, "\\'")}', 1)">ぽぽ</button>
                            <button class="group-btn ${productGroups[product] === 2 ? 'active' : ''}" 
                                    onclick="setGroup('${product.replace(/'/g, "\\'")}', 2)">ぽ</button>
                        </div>
                    </div>
                    <label class="ratio-toggle">
                        <input type="checkbox" onchange="toggleRatioSlider('${safeId}')">
                        利益分配割合を設定する
                    </label>
                    <div class="ratio-controls" id="ratio_${safeId}">
                        <div style="min-width: 80px; font-weight: 600; color: #73C2FB;">利益分配:</div>
                        <div class="ratio-slider-container">
                            <input type="range" min="0" max="100" step="5" value="${ratio}" 
                                   class="ratio-slider" id="slider_${safeId}"
                                   oninput="updateRatio('${product.replace(/'/g, "\\'")}', this.value)"
                                   style="background: linear-gradient(to right, #73C2FB 0%, #73C2FB ${ratio}%, #ADE0EE ${ratio}%, #ADE0EE 100%);">
                        </div>
                        <div class="ratio-display" id="display_${safeId}">
                            ぽぽ ${popoRatio}% : ぽ ${poRatio}%
                        </div>
                    </div>
                `;
                productList.appendChild(div);
            });
            
            document.getElementById('groupAssignment').style.display = 'block';
            document.getElementById('actionButtons').style.display = 'flex';
        }
        
        function toggleRatioSlider(safeId) {
            const ratioControls = document.getElementById(`ratio_${safeId}`);
            ratioControls.classList.toggle('active');
        }
        
        function updateRatio(product, value) {
            productRatios[product] = parseInt(value);
            const popoRatio = parseInt(value);
            const poRatio = 100 - popoRatio;
            
            const safeId = product.replace(/[^a-zA-Z0-9]/g, '_');
            const display = document.getElementById(`display_${safeId}`);
            const slider = document.getElementById(`slider_${safeId}`);
            
            if (display) {
                display.textContent = `ぽぽ ${popoRatio}% : ぽ ${poRatio}%`;
            }
            
            if (slider) {
                slider.style.background = `linear-gradient(to right, #73C2FB 0%, #73C2FB ${value}%, #ADE0EE ${value}%, #ADE0EE 100%)`;
            }
        }

        function setGroup(product, group) {
            productGroups[product] = group;
            displayProductList(Object.keys(productGroups));
        }

        function calculateResults() {
            document.getElementById('loading').style.display = 'block';
            
            setTimeout(() => {
                const aggregation = {};
                
                csvData.forEach(row => {
                    const productName = row['商品名'];
                    const amount = parseFloat(row['受取金額']) || 0;
                    const subtotal = parseFloat(row['小計']) || 0;
                    const selectedGroup = productGroups[productName] || 1;
                    const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                    const ratioCheckbox = document.getElementById(`ratio_${safeId}`);
                    
                    const isRatioEnabled = ratioCheckbox && ratioCheckbox.classList.contains('active');
                    
                    if (isRatioEnabled) {
                        const ratio = productRatios[productName] || 50;
                        const popoAmount = amount * (ratio / 100);
                        const poAmount = amount * ((100 - ratio) / 100);
                        const popoSubtotal = subtotal * (ratio / 100);
                        const poSubtotal = subtotal * ((100 - ratio) / 100);
                        
                        if (popoAmount > 0 || popoSubtotal > 0) {
                            const popoKey = `${productName}|||1`;
                            if (!aggregation[popoKey]) {
                                aggregation[popoKey] = { product: productName, group: 1, amount: 0, subtotal: 0, count: 0, ratio: ratio, isDivided: true };
                            }
                            if (amount > 0 || subtotal > 0) {
                                aggregation[popoKey].amount += popoAmount;
                                aggregation[popoKey].subtotal += popoSubtotal;
                                aggregation[popoKey].count += 1;
                            }
                        }
                        
                        if (poAmount > 0 || poSubtotal > 0) {
                            const poKey = `${productName}|||2`;
                            if (!aggregation[poKey]) {
                                aggregation[poKey] = { product: productName, group: 2, amount: 0, subtotal: 0, count: 0, ratio: 100 - ratio, isDivided: true };
                            }
                            if (amount > 0 || subtotal > 0) {
                                aggregation[poKey].amount += poAmount;
                                aggregation[poKey].subtotal += poSubtotal;
                                aggregation[poKey].count += 1;
                            }
                        }
                    } else {
                        const key = `${productName}|||${selectedGroup}`;
                        if (!aggregation[key]) {
                            aggregation[key] = { product: productName, group: selectedGroup, amount: 0, subtotal: 0, count: 0, ratio: 100, isDivided: false };
                        }
                        if (amount > 0 || subtotal > 0) {
                            aggregation[key].amount += amount;
                            aggregation[key].subtotal += subtotal;
                            aggregation[key].count += 1;
                        }
                    }
                });
                
                results = Object.values(aggregation)
                    .filter(r => r.amount > 0 || r.subtotal > 0)
                    .sort((a, b) => {
                        if (a.group !== b.group) return a.group - b.group;
                        return b.amount - a.amount;
                    });
                
                displayResults();
                document.getElementById('loading').style.display = 'none';
            }, 500);
        }

        function displayResults() {
            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;
            
            const group1Results = results.filter(r => r.group === 1);
            const group2Results = results.filter(r => r.group === 2);

            const group1Total = group1Results.reduce((sum, r) => sum + r.amount, 0);
            const group2Total = group2Results.reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = group1Total + group2Total;

            const group1Subtotal = group1Results.reduce((sum, r) => sum + r.subtotal, 0);
            const group2Subtotal = group2Results.reduce((sum, r) => sum + r.subtotal, 0);
            const grandSubtotal = group1Subtotal + group2Subtotal;

            const group1BoothFee = group1Subtotal - group1Total;
            const group2BoothFee = group2Subtotal - group2Total;
            const grandBoothFee = grandSubtotal - grandTotal;

            const group1Count = group1Results.reduce((sum, r) => sum + r.count, 0);
            const group2Count = group2Results.reduce((sum, r) => sum + r.count, 0);
            const grandCount = group1Count + group2Count;

            const group1Ratio = grandTotal > 0 ? group1Total / grandTotal : 0;
            const group2Ratio = grandTotal > 0 ? group2Total / grandTotal : 0;
            
            const group1Fee = transferFee * group1Ratio;
            const group2Fee = transferFee * group2Ratio;
            
            const group1Net = group1Total - group1Fee;
            const group2Net = group2Total - group2Fee;

            const cardStyle = `style="margin-top: 15px; padding: 10px 20px; background: white; color: #73C2FB; border: 2px solid white; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.9)'" onmouseout="this.style.background='white'"`;
            const dividerStyle = `style="border-top: 1px solid rgba(255,255,255,0.3); margin: 12px 0;"`;
            const rowStyle = `style="display:flex; justify-content:space-between; padding: 3px 0; font-size:0.9em;"`;
            const labelStyle = `style="opacity:0.85;"`;
            const valueStyle = `style="font-weight:600;"`;

            const summaryCards = document.getElementById('summaryCards');
            summaryCards.innerHTML = `
                <div class="result-card">
                    <h3>ぽぽ</h3>
                    <div class="result-amount">¥${Math.floor(group1Net).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(group1Subtotal).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料</span><span ${valueStyle}>-¥${Math.floor(Math.abs(group1BoothFee)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(group1Total).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>販売件数</span><span ${valueStyle}>${group1Count}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>商品数</span><span ${valueStyle}>${group1Results.length}商品</span></div>
                    <div ${rowStyle}><span ${labelStyle}>売上割合</span><span ${valueStyle}>${(group1Ratio * 100).toFixed(1)}%</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料</span><span ${valueStyle}>-¥${Math.round(group1Fee).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(group1Net).toLocaleString()}</span></div>
                    <button onclick="downloadGroupCSV(1)" ${cardStyle}>CSVを保存</button>
                </div>
                <div class="result-card">
                    <h3>ぽ</h3>
                    <div class="result-amount">¥${Math.floor(group2Net).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(group2Subtotal).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料</span><span ${valueStyle}>-¥${Math.floor(Math.abs(group2BoothFee)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(group2Total).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>販売件数</span><span ${valueStyle}>${group2Count}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>商品数</span><span ${valueStyle}>${group2Results.length}商品</span></div>
                    <div ${rowStyle}><span ${labelStyle}>売上割合</span><span ${valueStyle}>${(group2Ratio * 100).toFixed(1)}%</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料</span><span ${valueStyle}>-¥${Math.round(group2Fee).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(group2Net).toLocaleString()}</span></div>
                    <button onclick="downloadGroupCSV(2)" ${cardStyle}>CSVを保存</button>
                </div>
                <div class="result-card">
                    <h3>総合計</h3>
                    <div class="result-amount">¥${Math.floor(grandTotal - transferFee).toLocaleString()}</div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>売上合計（手数料前）</span><span ${valueStyle}>¥${Math.floor(grandSubtotal).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>BOOTH手数料</span><span ${valueStyle}>-¥${Math.floor(Math.abs(grandBoothFee)).toLocaleString()}</span></div>
                    <div ${rowStyle}><span ${labelStyle}>手数料差し引き後</span><span ${valueStyle}>¥${Math.floor(grandTotal).toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>総販売件数</span><span ${valueStyle}>${grandCount}件</span></div>
                    <div ${rowStyle}><span ${labelStyle}>総商品数</span><span ${valueStyle}>${results.length}商品</span></div>
                    <div ${rowStyle}><span ${labelStyle}>振込手数料</span><span ${valueStyle}>-¥${transferFee.toLocaleString()}</span></div>
                    <div ${dividerStyle}></div>
                    <div ${rowStyle}><span ${labelStyle}>受取金額</span><span style="font-weight:700; font-size:1.05em;">¥${Math.floor(grandTotal - transferFee).toLocaleString()}</span></div>
                    <button onclick="downloadResultsSummary()" ${cardStyle}>集計結果を保存</button>
                </div>
            `;
            
            // 詳細テーブル
            let tableHTML = `
                <thead>
                    <tr>
                        <th>グループ</th>
                        <th>商品名</th>
                        <th>分配割合</th>
                        <th>販売数</th>
                        <th>受取金額合計</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            results.forEach(result => {
                const ratioText = result.isDivided ? `${result.ratio}%` : '100%';
                tableHTML += `
                    <tr>
                        <td>${result.group === 1 ? 'ぽぽ' : 'ぽ'}</td>
                        <td class="clickable-product" onclick="showProductDetail('${result.product.replace(/'/g, "\\'")}', ${result.group})">${result.product}</td>
                        <td>${ratioText}</td>
                        <td>${result.count}件</td>
                        <td class="amount-cell">¥${Math.floor(result.amount).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            document.getElementById('detailsTable').innerHTML = tableHTML;
            document.getElementById('results').style.display = 'block';
        }

        function downloadResultsSummary() {
            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;
            
            let csv = 'グループ,商品名,分配割合,販売数,受取金額合計\n';
            
            results.forEach(result => {
                const groupName = result.group === 1 ? 'ぽぽ' : 'ぽ';
                const ratioText = result.isDivided ? `${result.ratio}%` : '100%';
                csv += `${groupName},"${result.product}",${ratioText},${result.count},${Math.floor(result.amount)}\n`;
            });
            
            // サマリー行を追加
            const group1Total = results.filter(r => r.group === 1).reduce((sum, r) => sum + r.amount, 0);
            const group2Total = results.filter(r => r.group === 2).reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = group1Total + group2Total;
            
            const group1Ratio = grandTotal > 0 ? group1Total / grandTotal : 0;
            const group2Ratio = grandTotal > 0 ? group2Total / grandTotal : 0;
            
            const group1Fee = Math.round(transferFee * group1Ratio);
            const group2Fee = Math.round(transferFee * group2Ratio);
            
            const group1Net = group1Total - group1Fee;
            const group2Net = group2Total - group2Fee;
            
            csv += '\n集計サマリー\n';
            csv += `ぽぽ合計,,${results.filter(r => r.group === 1).reduce((sum, r) => sum + r.count, 0)},${group1Total}\n`;
            csv += `ぽぽ売上割合,,,${(group1Ratio * 100).toFixed(1)}%\n`;
            csv += `ぽぽ振込手数料負担,,,-${group1Fee}\n`;
            csv += `ぽぽ受取金額,,,${Math.floor(group1Net)}\n`;
            csv += '\n';
            csv += `ぽ合計,,${results.filter(r => r.group === 2).reduce((sum, r) => sum + r.count, 0)},${group2Total}\n`;
            csv += `ぽ売上割合,,,${(group2Ratio * 100).toFixed(1)}%\n`;
            csv += `ぽ振込手数料負担,,,-${group2Fee}\n`;
            csv += `ぽ受取金額,,,${Math.floor(group2Net)}\n`;
            csv += '\n';
            csv += `総合計,,${results.reduce((sum, r) => sum + r.count, 0)},${grandTotal}\n`;
            csv += `振込手数料合計,,,-${transferFee}\n`;
            csv += `受取金額,,,${Math.floor(grandTotal - transferFee)}\n`;
            
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${originalFileName}_集計結果.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function downloadGroupCSV(group) {
            if (csvData.length === 0) {
                alert('まずCSVファイルを読み込んでください');
                return;
            }
            
            const groupName = group === 1 ? 'ぽぽ' : 'ぽ';
            
            // ヘッダー行を取得（元のCSVと同じ順序）
            const headers = Object.keys(csvData[0]);
            
            // グループに属する商品のデータのみフィルタリング
            const groupData = csvData.filter(row => {
                const productName = row['商品名'];
                const amount = parseFloat(row['受取金額']) || 0;
                
                if (amount > 0) {
                    const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                    const ratioControls = document.getElementById(`ratio_${safeId}`);
                    const isRatioEnabled = ratioControls && ratioControls.classList.contains('active');
                    
                    if (isRatioEnabled) {
                        // 分配設定がある場合は割合に応じて判定
                        const ratio = productRatios[productName] || 50;
                        const popoRatio = ratio;
                        const poRatio = 100 - ratio;
                        
                        if (group === 1) {
                            return popoRatio > 0;
                        } else {
                            return poRatio > 0;
                        }
                    } else {
                        // 分配設定がない場合は選択グループのみ
                        const selectedGroup = productGroups[productName] || 1;
                        return selectedGroup === group;
                    }
                }
                return false;
            });
            
            if (groupData.length === 0) {
                alert(`${groupName}に割り当てられた商品がありません`);
                return;
            }
            
            // CSV文字列を生成
            let csv = '';
            
            // ヘッダー行（分配割合と分配後金額を追加）
            csv += headers.map(h => `"${h}"`).join(',') + ',"利益分配割合","分配後受取金額"\n';
            
            // データ行
            groupData.forEach(row => {
                const productName = row['商品名'];
                const originalAmount = parseFloat(row['受取金額']) || 0;
                const safeId = productName.replace(/[^a-zA-Z0-9]/g, '_');
                const ratioControls = document.getElementById(`ratio_${safeId}`);
                const isRatioEnabled = ratioControls && ratioControls.classList.contains('active');
                
                let groupRatio, distributedAmount, ratioLabel;
                
                if (isRatioEnabled) {
                    // 分配設定がある場合
                    const ratio = productRatios[productName] || 50;
                    groupRatio = group === 1 ? ratio : (100 - ratio);
                    distributedAmount = Math.floor(originalAmount * (groupRatio / 100));
                    ratioLabel = `${groupName} ${groupRatio}%`;
                } else {
                    // 分配設定がない場合は100%
                    groupRatio = 100;
                    distributedAmount = originalAmount;
                    ratioLabel = `${groupName} 100%`;
                }
                
                const values = headers.map(header => {
                    const value = row[header] || '';
                    // 値にカンマや改行が含まれる場合はダブルクォートで囲む
                    if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return `"${value}"`;
                });
                csv += values.join(',') + `,"${ratioLabel}","${distributedAmount}"\n`;
            });
            
            // 合計行を追加
            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;
            const group1Total = results.filter(r => r.group === 1).reduce((sum, r) => sum + r.amount, 0);
            const group2Total = results.filter(r => r.group === 2).reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = group1Total + group2Total;
            
            const groupTotal = group === 1 ? group1Total : group2Total;
            const groupRatio = grandTotal > 0 ? groupTotal / grandTotal : 0;
            const groupFee = Math.round(transferFee * groupRatio);
            const groupNet = groupTotal - groupFee;
            const groupCount = groupData.reduce((sum, row) => {
                const amount = parseFloat(row['受取金額']) || 0;
                return amount > 0 ? sum + 1 : sum;
            }, 0);
            
            csv += '\n';
            csv += `"${groupName} 集計サマリー"\n`;
            csv += `"販売数","${groupCount}件"\n`;
            csv += `"受取金額合計","${groupTotal}円"\n`;
            csv += `"売上割合","${(groupRatio * 100).toFixed(1)}%"\n`;
            csv += `"振込手数料負担","-${groupFee}円"\n`;
            csv += `"受取金額","${Math.floor(groupNet)}円"\n`;
            
            // ダウンロード
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${originalFileName}_${groupName}合計.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function copyResultsAsText() {
            if (results.length === 0) {
                alert('まず集計を実行してください');
                return;
            }
            
            const transferFee = parseFloat(document.getElementById('transferFee').value) || 0;
            
            // 集計データを計算
            const group1Total = results.filter(r => r.group === 1).reduce((sum, r) => sum + r.amount, 0);
            const group2Total = results.filter(r => r.group === 2).reduce((sum, r) => sum + r.amount, 0);
            const grandTotal = group1Total + group2Total;
            
            const group1Ratio = grandTotal > 0 ? group1Total / grandTotal : 0;
            const group2Ratio = grandTotal > 0 ? group2Total / grandTotal : 0;
            
            const group1Fee = Math.round(transferFee * group1Ratio);
            const group2Fee = Math.round(transferFee * group2Ratio);
            
            const group1Net = group1Total - group1Fee;
            const group2Net = group2Total - group2Fee;
            
            // テキスト生成
            let text = '━━━━━━━━━━━━━━━━━━━━\n';
            text += '売上集計結果\n';
            text += '━━━━━━━━━━━━━━━━━━━━\n\n';
            
            // ぽぽの集計
            text += '【ぽぽ】\n';
            text += `売上合計: ¥${group1Total.toLocaleString()}\n`;
            text += `売上割合: ${(group1Ratio * 100).toFixed(1)}%\n`;
            text += `振込手数料: -¥${group1Fee.toLocaleString()}\n`;
            text += `受取金額: ¥${Math.floor(group1Net).toLocaleString()}\n`;
            text += `商品数: ${results.filter(r => r.group === 1).length}商品\n\n`;
            
            // ぽぽの商品詳細
            const group1Items = results.filter(r => r.group === 1);
            if (group1Items.length > 0) {
                text += '＜商品詳細＞\n';
                group1Items.forEach(item => {
                    text += `  • ${item.product}\n`;
                    text += `    販売数: ${item.count}件 / 金額: ¥${item.amount.toLocaleString()}\n`;
                });
                text += '\n';
            }
            
            text += '━━━━━━━━━━━━━━━━━━━━\n\n';
            
            // ぽの集計
            text += '【ぽ】\n';
            text += `売上合計: ¥${group2Total.toLocaleString()}\n`;
            text += `売上割合: ${(group2Ratio * 100).toFixed(1)}%\n`;
            text += `振込手数料: -¥${group2Fee.toLocaleString()}\n`;
            text += `受取金額: ¥${Math.floor(group2Net).toLocaleString()}\n`;
            text += `商品数: ${results.filter(r => r.group === 2).length}商品\n\n`;
            
            // ぽの商品詳細
            const group2Items = results.filter(r => r.group === 2);
            if (group2Items.length > 0) {
                text += '＜商品詳細＞\n';
                group2Items.forEach(item => {
                    text += `  • ${item.product}\n`;
                    text += `    販売数: ${item.count}件 / 金額: ¥${item.amount.toLocaleString()}\n`;
                });
                text += '\n';
            }
            
            text += '━━━━━━━━━━━━━━━━━━━━\n\n';
            
            // 総合計
            text += '【総合計】\n';
            text += `総売上: ¥${grandTotal.toLocaleString()}\n`;
            text += `振込手数料: -¥${transferFee.toLocaleString()}\n`;
            text += `受取金額: ¥${Math.floor(grandTotal - transferFee).toLocaleString()}\n`;
            text += `総商品数: ${results.length}商品\n`;
            text += `総販売数: ${results.reduce((sum, r) => sum + r.count, 0)}件\n`;
            
            // クリップボードにコピー
            navigator.clipboard.writeText(text).then(() => {
                showCopyNotification();
            }).catch(err => {
                // フォールバック: テキストエリアを使った古い方法
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showCopyNotification();
            });
        }
        
        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function showProductDetail(productName, group) {
            // 該当商品のデータを取得
            const productDetails = csvData.filter(row => row['商品名'] === productName);
            
            if (productDetails.length === 0) {
                alert('商品データが見つかりません');
                return;
            }
            
            // 合計を計算
            const totalAmount = productDetails.reduce((sum, row) => sum + (parseFloat(row['受取金額']) || 0), 0);
            const totalCount = productDetails.length;
            
            // モーダルのタイトルを設定
            document.getElementById('modalProductName').textContent = productName;
            
            // モーダルの内容を生成
            let modalContent = `
                <div class="detail-summary">
                    <div class="detail-summary-item">
                        <span>グループ:</span>
                        <span><strong>${group === 1 ? 'ぽぽ' : 'ぽ'}</strong></span>
                    </div>
                    <div class="detail-summary-item">
                        <span>総販売数:</span>
                        <span><strong>${totalCount}件</strong></span>
                    </div>
                    <div class="detail-summary-item">
                        <span>受取金額合計:</span>
                        <span><strong>¥${totalAmount.toLocaleString()}</strong></span>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: #333;">注文詳細</h3>
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>注文日時</th>
                            <th>注文番号</th>
                            <th>バリエーション</th>
                            <th>単価</th>
                            <th>数量</th>
                            <th>受取金額</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 注文データを日付順にソート
            productDetails.sort((a, b) => {
                return new Date(b['注文日時']) - new Date(a['注文日時']);
            });
            
            productDetails.forEach(row => {
                const orderDate = row['注文日時'] || '-';
                const orderNumber = row['注文番号'] || '-';
                const variation = row['バリエーション名'] || '-';
                const price = row['単価'] || '0';
                const quantity = row['数量'] || '0';
                const amount = parseFloat(row['受取金額']) || 0;
                
                modalContent += `
                    <tr>
                        <td>${orderDate}</td>
                        <td>${orderNumber}</td>
                        <td>${variation}</td>
                        <td>¥${parseFloat(price).toLocaleString()}</td>
                        <td>${quantity}</td>
                        <td style="font-weight: 600; color: #28a745;">¥${amount.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            modalContent += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('modalBody').innerHTML = modalContent;
            document.getElementById('detailModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        // モーダル外をクリックしたら閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
